<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Partager ma position avec GPWS</title>
  <style>
    body {
      background: black;
      color: lime;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 1em;
      margin: 0;
    }
    input, button {
      background: black;
      color: lime;
      border: 1px solid lime;
      padding: 8px;
      font-family: monospace;
    }
    button:hover {
      background: lime;
      color: black;
      cursor: pointer;
    }
#gpwsAlert {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 90vw;
  max-width: 400px;
  margin-top: 10px;
  gap: 5px;
}

    @keyframes blink {
      0% {opacity: 1;}
      100% {opacity: 0.3;}
    }
  </style>
</head>
<body>
  <h1>PARTAGE POSITION + GPWS</h1>
  <input type="text" id="callsign" placeholder="Callsign" />
  <button id="startBtn">Démarrer</button>
  <button id="stopBtn" style="display:none;">Arrêter</button>

  <div id="gpwsAlert"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyABEP_KAW9R4dYpnDS9BANn6vcQCICxzrU",
      authDomain: "kenzomc-ad1c2.firebaseapp.com",
      databaseURL: "https://kenzomc-ad1c2-default-rtdb.firebaseio.com",
      projectId: "kenzomc-ad1c2",
      storageBucket: "kenzomc-ad1c2.firebasestorage.app",
      messagingSenderId: "459457032331",
      appId: "1:459457032331:web:af7e0d8c958a807ce2648e",
      measurementId: "G-341YD1GPC5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const callsignInput = document.getElementById("callsign");
    const gpwsAlert = document.getElementById("gpwsAlert");

    let watchId = null;
    let lastLat = null, lastLon = null, lastTime = null;

    let prevAltitude = null;
    let prevTime = null;
    let devicePitch = 0;



    // Sons locaux (à placer dans le même dossier)
    const sounds = {
      stall: new Audio('stall.mp3'),     // Son décrochage
      sinkRate: new Audio('sinkrate.mp3'), // Son sink rate
      terrain: new Audio('terrain.mp3')    // Son terrain ahead
    };

    // Cooldown en ms pour éviter répétition trop fréquente
    const alarmCooldown = 1000;
    let lastAlarmTime = {
      stall: 0,
      sinkRate: 0,
      terrain: 0
    };

    function playAlarm(type) {
      if (sounds[type]) {
        try {
          sounds[type].currentTime = 0;
          sounds[type].play();
        } catch (e) {
          console.warn("Erreur lecture son:", e);
        }
      }
    }

function showAlert(message) {
  const div = document.createElement("div");
  div.textContent = message;
  div.style.border = "2px solid red";
  div.style.padding = "10px";
  div.style.marginTop = "5px";
  div.style.animation = "blink 1s infinite alternate";
  div.style.color = "red";
  div.style.textAlign = "center";
  div.style.fontWeight = "bold";
  gpwsAlert.appendChild(div);

  setTimeout(() => {
    gpwsAlert.removeChild(div);
  }, 5000);
}


    // Simulation pitch (à ajuster si tu as la donnée)
    // Ici on fixe pitch = 15° quand speed < 120 pour test stall


    // Fonction GPWS
    function checkGPWS(data) {
      const now = Date.now();

      const pitch = data.pitch = devicePitch;
      const speed = data.speed || 0; // km/h
      const altitude = typeof data.altitude === 'number' ? data.altitude : 9999;
      const verticalSpeed = data.verticalSpeed || 0; // m/s

      // Décrochage (stall): pitch > 10° & vitesse < 120 km/h
      if (pitch > 10 && speed > 10 && speed < 120) {
        if (now - lastAlarmTime.stall > alarmCooldown) {
          playAlarm('stall');
          lastAlarmTime.stall = now;
          showAlert("STALL WARNING - Décrochage détecté !");
        }
      }

      // Sink rate: descente rapide > 10 m/s
      if (verticalSpeed < -10) {
        if (now - lastAlarmTime.sinkRate > alarmCooldown) {
          playAlarm('sinkrate');
          lastAlarmTime.sinkrate = now;
          showAlert("SINK RATE! Sink rate!");
        }
      }

      // Terrain ahead: altitude < 160m
      if (altitude < 160) {
        if (now - lastAlarmTime.terrain > alarmCooldown) {
          playAlarm('terrain');
          lastAlarmTime.terrain = now;
          showAlert("TERRAIN AHEAD! Pull up! Pull up! Pull up!");
        }
      }
    }

    startBtn.onclick = () => {
      const callsign = callsignInput.value.trim().toUpperCase();
      if (!callsign) return alert("Entrez un callsign.");
      // Demander la permission deviceorientation (iOS)
if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
  DeviceOrientationEvent.requestPermission()
    .then(state => {
      if (state === 'granted') {
        window.addEventListener("deviceorientation", event => {
          if (event.beta !== null) {
            devicePitch = event.beta;
          }
        });
      } else {
        alert("Autorisation capteurs refusée. Le GPWS ne fonctionnera pas.");
      }
    })
    .catch(err => {
      alert("Erreur permission capteurs : " + err);
    });
} else {
  // Android ou desktop
  window.addEventListener("deviceorientation", event => {
    if (event.beta !== null) {
      devicePitch = event.beta;
    }
  });
}

      
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";

      // Déclenche un son silencieux pour débloquer autoplay audio
      // (certains navigateurs exigent interaction avant son)
      sounds.stall.play().then(() => sounds.stall.pause()).catch(() => {});

      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, altitude } = pos.coords;
          const now = Date.now();

          let heading = 0;
          let speed = 0;

          if (lastLat !== null && lastLon !== null && lastTime !== null) {
            const dLat = latitude - lastLat;
            const dLon = longitude - lastLon;
            const dist = Math.sqrt(dLat * dLat + dLon * dLon) * 111000;
            const dt = (now - lastTime) / 1000;
            speed = (dist / dt) * 3.6;
            heading = Math.atan2(dLon, dLat) * (180 / Math.PI);
            heading = (heading + 360) % 360;
          }

          lastLat = latitude;
          lastLon = longitude;
          lastTime = now;

          db.ref("positions/" + callsign).set({
            lat: latitude,
            lon: longitude,
            altitude: altitude || null,
            speed: speed,
            heading: heading,
            lastUpdate: now,
            stopped: false,
            emergency: false
          });
        },
        err => alert("Erreur GPS : " + err.message),
        { enableHighAccuracy: true }
      );

      // Écoute Firebase en temps réel
      db.ref("positions/" + callsign).on("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;

        if (prevAltitude === null) prevAltitude = data.altitude || 0;
        if (prevTime === null) prevTime = data.lastUpdate || Date.now();

        const dt = (data.lastUpdate || Date.now()) - prevTime;
        const dz = (data.altitude || 0) - prevAltitude;

        const verticalSpeed = dt > 0 ? (dz / (dt / 1000)) : 0;

        prevAltitude = data.altitude || 0;
        prevTime = data.lastUpdate || Date.now();

        data.verticalSpeed = verticalSpeed;

        checkGPWS(data);
      });
    };

    stopBtn.onclick = () => {
      const callsign = callsignInput.value.trim().toUpperCase();
      if (!callsign) return;

      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      db.ref("positions/" + callsign).update({
        stopped: true,
        lastUpdate: Date.now()
      });

      startBtn.style.display = "inline-block";

      // Supprime l'écoute Firebase
      db.ref("positions/" + callsign).off();

      gpwsAlert.style.display = "none";
      prevAltitude = null;
      prevTime = null;
    };
  </script>
</body>
</html>
