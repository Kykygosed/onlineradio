<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Partager ma position avec GPWS</title>
  <style>
    body {
      background: black;
      color: lime;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 1em;
      margin: 0;
    }
    input, button {
      background: black;
      color: lime;
      border: 1px solid lime;
      padding: 8px;
      font-family: monospace;
    }
    button:hover {
      background: lime;
      color: black;
      cursor: pointer;
    }
    #gpwsAlert {
      display: none;
      font-weight: bold;
      font-size: 1.2em;
      padding: 10px;
      border: 2px solid red;
      color: red;
      text-align: center;
      width: 90vw;
      max-width: 400px;
      margin-top: 10px;
      animation: blink 1s infinite alternate;
    }
    @keyframes blink {
      0% {opacity: 1;}
      100% {opacity: 0.3;}
    }
  </style>
</head>
<body>
  <h1>PARTAGE POSITION + GPWS</h1>
  <input type="text" id="callsign" placeholder="Callsign" />
  <button id="startBtn">Démarrer</button>
  <button id="stopBtn" style="display:none;">Arrêter</button>

  <div id="gpwsAlert"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyABEP_KAW9R4dYpnDS9BANn6vcQCICxzrU",
      authDomain: "kenzomc-ad1c2.firebaseapp.com",
      databaseURL: "https://kenzomc-ad1c2-default-rtdb.firebaseio.com",
      projectId: "kenzomc-ad1c2",
      storageBucket: "kenzomc-ad1c2.firebasestorage.app",
      messagingSenderId: "459457032331",
      appId: "1:459457032331:web:af7e0d8c958a807ce2648e",
      measurementId: "G-341YD1GPC5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const callsignInput = document.getElementById("callsign");
    const gpwsAlert = document.getElementById("gpwsAlert");

    let watchId = null;
    let lastLat = null, lastLon = null, lastTime = null;

    let prevAltitude = null;
    let prevTime = null;

    // Alarm URLs SoundCloud / Zapsplat
    const alarms = {
      stall: "https://soundcloud.com/darcy-gallagher-918811888/airbus-stall-warning",
      sinkRate: "https://www.zapsplat.com/music/airliner-cockpit-ground-proximity-warning-system-gpws-voice-says-sink-rate/",
      terrain: "https://soundcloud.com/james-lost-376224251/tupolev-tu-154-pull-up-alarm"
    };

    // Cooldown en ms
    const alarmCooldown = 15000;
    let lastAlarmTime = {
      stall: 0,
      sinkRate: 0,
      terrain: 0
    };

    function playAlarm(url) {
      // Pour SoundCloud, on doit utiliser un player iframe ou API dédiée
      // Ici on va juste jouer un son générique car jouer direct un lien SC ne marche pas
      // Alternativement, on peut héberger un mp3 direct ou utiliser un player tiers
      // Pour la démo, on joue un bip simple (à remplacer par ton système audio)
      console.log("Play alarm:", url);

      // Pour jouer un son simple local ou une URL mp3 directe, tu peux faire :
      /*
      const audio = new Audio(url);
      audio.play();
      */
      // Mais SoundCloud ne permet pas ça directement via URL publique.

      // Solution simple ici : afficher message et demander à l'utilisateur d'ouvrir le lien.
      alert("ALERTE GPWS\nCliquez OK pour écouter l'alarme:\n" + url);
      window.open(url, "_blank");
    }

    function showAlert(message) {
      gpwsAlert.textContent = message;
      gpwsAlert.style.display = "block";
      setTimeout(() => {
        gpwsAlert.style.display = "none";
      }, 5000);
    }

    // Fonction GPWS
    function checkGPWS(data) {
      const now = Date.now();

      // Pitch simulé: pas dispo, on met 0
      const pitch = data.pitch || 0;
      const speed = data.speed || 0; // km/h
      const altitude = data.altitude || 0; // m
      const verticalSpeed = data.verticalSpeed || 0; // m/s

      // Décrochage (stall): pitch > 10° & vitesse < 120 km/h (exemple)
      if (pitch > 10 && speed < 120) {
        if (now - lastAlarmTime.stall > alarmCooldown) {
          playAlarm(alarms.stall);
          lastAlarmTime.stall = now;
          showAlert("STALL WARNING - Décrochage détecté !");
        }
      }

      // Sink rate: descente rapide > 10 m/s
      if (verticalSpeed < -10) {
        if (now - lastAlarmTime.sinkRate > alarmCooldown) {
          playAlarm(alarms.sinkRate);
          lastAlarmTime.sinkRate = now;
          showAlert("SINK RATE! Sink rate!");
        }
      }

      // Terrain ahead: altitude < 160m
      if (altitude < 160) {
        if (now - lastAlarmTime.terrain > alarmCooldown) {
          playAlarm(alarms.terrain);
          lastAlarmTime.terrain = now;
          showAlert("TERRAIN AHEAD! Pull up! Pull up! Pull up!");
        }
      }
    }

    startBtn.onclick = () => {
      const callsign = callsignInput.value.trim().toUpperCase();
      if (!callsign) return alert("Entrez un callsign.");

      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";

      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, altitude } = pos.coords;
          const now = Date.now();

          let heading = 0;
          let speed = 0;

          if (lastLat !== null && lastLon !== null && lastTime !== null) {
            const dLat = latitude - lastLat;
            const dLon = longitude - lastLon;
            const dist = Math.sqrt(dLat * dLat + dLon * dLon) * 111000;
            const dt = (now - lastTime) / 1000;
            speed = (dist / dt) * 3.6;
            heading = Math.atan2(dLon, dLat) * (180 / Math.PI);
            heading = (heading + 360) % 360;
          }

          lastLat = latitude;
          lastLon = longitude;
          lastTime = now;

          db.ref("positions/" + callsign).set({
            lat: latitude,
            lon: longitude,
            altitude: altitude || null,
            speed: speed,
            heading: heading,
            lastUpdate: now,
            stopped: false,
            emergency: false
          });
        },
        err => alert("Erreur GPS : " + err.message),
        { enableHighAccuracy: true }
      );

      // Écoute Firebase en temps réel
      db.ref("positions/" + callsign).on("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;

        if (prevAltitude === null) prevAltitude = data.altitude || 0;
        if (prevTime === null) prevTime = data.lastUpdate || Date.now();

        const dt = (data.lastUpdate || Date.now()) - prevTime;
        const dz = (data.altitude || 0) - prevAltitude;

        const verticalSpeed = dt > 0 ? (dz / (dt / 1000)) : 0;

        prevAltitude = data.altitude || 0;
        prevTime = data.lastUpdate || Date.now();

        data.verticalSpeed = verticalSpeed;
        data.pitch = 0; // Pas dispo, à ajuster si tu as la valeur

        checkGPWS(data);
      });
    };

    stopBtn.onclick = () => {
      const callsign = callsignInput.value.trim().toUpperCase();
      if (!callsign) return;

      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      db.ref("positions/" + callsign).update({
        stopped: true,
        lastUpdate: Date.now()
      });

      startBtn.style.display = "inline-block";
      stopBtn.style.display = "none";

      // Supprime l'écoute Firebase
      db.ref("positions/" + callsign).off();
      
      // Reset alert & vars
      gpwsAlert.style.display = "none";
      prevAltitude = null;
      prevTime = null;
    };
  </script>
</body>
</html>
